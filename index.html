<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Collection</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="sidebar">
        <input type="checkbox" id="checkmn" checked />
        <label for="checkmn" id="toggle-btn">‚ò∞</label>

        <a href="index.html" class="active">üìä <span>Character Status</span></a>
        <a href="create.html">‚ûï <span>Create New Character</span></a>
        <a href="tier_list.html">üèÜ <span>Tier List</span></a> 
        <a href="update_list.html">üìù <span>Character Update</span></a>
        <a href="backup_recovery.html">üíæ <span>Backup/Recovery</span></a>
    </div>

    <div id="main-content">
        <h1>Current Character Status</h1>
        
        <div id="filter-controls">
            <label for="sort-by">Sort:</label>
            <select id="sort-by">
                <option value="power" selected>Power</option>
                <option value="skillProgress">Skill Progress</option>
                <option value="default">Default (Element)</option>
                <option value="level">Level</option>
                <option value="star">Star</option>
                <option value="cardLevel">Card Level</option>
                <option value="cardStar">Card Star</option>
                <option value="shards">Shards</option>
            </select>
            <button id="sort-button">Sort</button>
        </div>

        <div id="card-container"></div>
        
        <div id="load-error"></div>
    </div>

  <script>
    // Konstanta kunci penyimpanan
    const STORAGE_KEY = 'CHARACTER_DATA_V1';
    let charactersData = []; 

    // --- FUNGSI IKON BINTANG ---
    function generateStarIcons(currentStar) {
        const maxStar = 6;
        let starsHtml = '';
        for (let i = 0; i < maxStar; i++) {
            starsHtml += `<span style="color: ${i < currentStar ? 'gold' : '#444'};">${i < currentStar ? '‚òÖ' : '‚òÜ'}</span>`;
        }
        return starsHtml;
    }

    // --- GENERATE HTML MODE BACA (READ-ONLY) ---
    function createCardHTML(data, index) {
        const currentShards = parseInt(data.shards) || 0;
        const maxShards = parseInt(data.shardMax) || 0;
        const restShards = Math.max(0, maxShards - currentShards);
        const shardPercentage = Math.min((currentShards / maxShards) * 100, 100);
        const elementClass = `element-${data.element}`;
        const starIcons = generateStarIcons(data.star); 
        const cardStarIcons = generateStarIcons(data.cardStar);

        // Data for skill progress
        const skillProgress = data.skillProgress || { tracked: false, skill: 'skillTwo', current: 0, max: 1000 };
        const isTracked = skillProgress.tracked;
        const skillProgressPercentage = Math.min((skillProgress.current / skillProgress.max) * 100, 100);
        const skillNameMap = { skillOne: 'Skill 1', skillTwo: 'Skill 2', skillThree: 'Skill 3' };
        const trackedSkillName = skillNameMap[skillProgress.skill] || 'Skill';

        return `
            <div class="char-card ${elementClass} ${isTracked ? 'progress-tracked' : ''}" id="card-${index}" onclick="handleCardClick(this, event)"> 
                <div class="card-header">
                    <div class="grid-2-row header-left">
                        <span class="char-icon"><img src="img/${data.name}.png" alt="${data.name}" onerror="this.src='img/default.png'"></span>
                        <span class="char-rank rank-${data.rank}">${data.rank}</span>
                    </div>
                    <div class="header-right">
                        <div class="header-top-right">
                            <button class="bookmark-btn" onclick="toggleSkillProgress(${index}, event)">
                                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>
                            </button>
                            <button class="edit-btn" onclick="activateEditMode(${index}, event)">‚úèÔ∏è</button>
                        </div>
                        <span class="char-name">${data.name}</span>
                        <span class="char-star">${starIcons}</span>
                    </div>
                </div>

                <div class="grid-5 main-stats">
                    <div class="grid-item"><span class="grid-label">Level</span><span class="grid-value">${data.level}</span></div>
                    <div class="grid-item"><span class="grid-label">Intimacy</span><span class="grid-value">${data.intimacy}</span></div>
                    <div class="grid-item"><span class="grid-label">Element</span><span class="grid-value">${data.element}</span></div>
                    <div class="grid-item"><span class="grid-label">Role</span><span class="grid-value">${data.role}</span></div>
                    <div class="grid-item"><span class="grid-label">‚öîÔ∏è Power</span><span class="grid-value">${data.power}</span></div>
                </div>

                <div class="grid-5">
                    <div class="label grid-item" style="margin-top: 5px;">Skills</div>
                    <div class="grid-item"><span class="grid-label">S1</span><span class="grid-value">${data.skillOneLevel}</span></div>
                    <div class="grid-item"><span class="grid-label">S2</span><span class="grid-value">${data.skillTwoLevel}</span></div>
                    <div class="grid-item"><span class="grid-label">S3</span><span class="grid-value">${data.skillThreeLevel}</span></div>
                    <div class="grid-item"><span class="grid-label">S4</span><span class="grid-value">${data.skillFourLevel}</span></div>
                </div>

                <div class="grid-2-row skill-progress-details">
                    <div class="grid-item" style="border:none; padding:0;">
                        <span class="grid-label skill-progress-name"><b>${trackedSkillName} ‚ñ∂</b></span>
                    </div>
                    <div class="grid-item>
                        <span class="grid-label skill-progress-name"><b>${skillProgress.current} / ${skillProgress.max} (<span style="color:#ff7043;">${skillProgress.max - skillProgress.current}</span>)</b></span>
                        <div class="grid-value progress-bg">
                            <div class="progress-fill" style="width: ${skillProgressPercentage}%"></div>
                        </div>
                    </div>
                </div>

                <div class="grid-2-row">
                    <div class="grid-item" style="border:none; padding:0;">
                        <span class="grid-label">Shards <b>${currentShards} / ${maxShards} (<span style="color:#ff7043;">${restShards}</span>)</b></span>
                        <div class="grid-value progress-bg">
                            <div class="progress-fill" style="width: ${shardPercentage}%"></div>
                        </div>
                    </div>
                    <div class="grid-item" style="border:none;">
                        <span class="grid-label">Card Lv <b>${data.cardLevel}</b></span>
                        <span class="grid-value" style="color: gold;">${cardStarIcons}</span>
                    </div>
                </div>
            </div>
        `;
    }

    // --- GENERATE HTML MODE EDIT (FORM INPUT) ---
    function createEditFormHTML(data, index) {
        const elementClass = `element-${data.element}`;
        const skillProgress = data.skillProgress || { tracked: false, skill: 'skillTwo', current: 0, max: 1000 };

        return `
            <div class="char-card ${elementClass}" style="border: 2px solid var(--accent); cursor: default;" onclick="event.stopPropagation()"> 
                <div class="card-header">
                     <div class="header-left">
                        <span class="char-icon"><img src="img/${data.name}.png" onerror="this.src='img/default.png'"></span>
                     </div>
                    <div class="header-right">
                        <span class="grid-item char-name">${data.name}</span>
                        <input type="number" class="edit-input" id="edit-star-${index}" value="${data.star}" min="1" max="6" placeholder="Star">
                    </div>
                </div>
                
                <!-- Main stats and skills grids here for brevity -->
                 <div class="grid-5 main-stats">
                    <div class="grid-item"><span class="grid-label">Level</span><input type="number" class="edit-input" id="edit-level-${index}" value="${data.level}"></div>
                    <div class="grid-item"><span class="grid-label">Intimacy</span><input type="number" class="edit-input" id="edit-intimacy-${index}" value="${data.intimacy}"></div>
                    <div class="grid-item"><span class="grid-label">Element</span>
                        <select class="edit-input" id="edit-element-${index}" value="${data.element}"></select>
                    </div>
                    <div class="grid-item"><span class="grid-label">Role</span><input type="text" class="edit-input" id="edit-role-${index}" value="${data.role}"></div>
                    <div class="grid-item"><span class="grid-label">‚öîÔ∏è Power</span><input type="text" class="edit-input" id="edit-power-${index}" value="${data.power}"></div>
                </div>

                <div class="grid-5">
                    <div class="label grid-item">Skills</div>
                    <div class="grid-item"><span class="grid-label">S1</span><input type="number" class="edit-input" id="edit-s1-${index}" value="${data.skillOneLevel}"></div>
                    <div class="grid-item"><span class="grid-label">S2</span><input type="number" class="edit-input" id="edit-s2-${index}" value="${data.skillTwoLevel}"></div>
                    <div class="grid-item"><span class="grid-label">S3</span><input type="number" class="edit-input" id="edit-s3-${index}" value="${data.skillThreeLevel}"></div>
                    <div class="grid-item"><span class="grid-label">S4</span><input type="number" class="edit-input" id="edit-s4-${index}" value="${data.skillFourLevel}"></div>
                </div>
                
                <!-- NEW SKILL PROGRESS EDIT FORM -->
                <div class="edit-skill-progress">
                    <div class="grid-item"><span class="grid-label">Tracked Skill</span>
                        <select class="edit-input" id="edit-trackedSkill-${index}">
                            <option value="skillOne" ${skillProgress.skill === 'skillOne' ? 'selected' : ''}>Skill 1</option>
                            <option value="skillTwo" ${skillProgress.skill === 'skillTwo' ? 'selected' : ''}>Skill 2</option>
                            <option value="skillThree" ${skillProgress.skill === 'skillThree' ? 'selected' : ''}>Skill 3</option>
                        </select>
                    </div>
                    <div class="grid-item"><span class="grid-label">Current</span>
                        <input type="number" class="edit-input" id="edit-skillCurrent-${index}" value="${skillProgress.current}">
                    </div>
                    <div class="grid-item"><span class="grid-label">Max</span>
                        <input type="number" class="edit-input" id="edit-skillMax-${index}" value="${skillProgress.max}">
                    </div>
                </div>

                <div class="grid-2-row">
                    <div class="grid-item" style="border:none;">
                         <span class="grid-label">Shards (Cur/Max)</span>
                         <div style="display:flex; gap:2px;">
                            <input type="number" class="edit-input" id="edit-shards-${index}" value="${data.shards}">
                            <input type="number" class="edit-input" id="edit-shardMax-${index}" value="${data.shardMax}">
                         </div>
                    </div>
                    <div class="grid-item" style="border:none;">
                        <span class="grid-label">Card Lv/Star</span>
                        <div style="display:flex; gap:2px;">
                            <input type="number" class="edit-input" id="edit-cardLevel-${index}" value="${data.cardLevel}">
                            <input type="number" class="edit-input" id="edit-cardStar-${index}" value="${data.cardStar}">
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-cancel" onclick="cancelEdit(${index})">Batal</button>
                    <button class="btn-save" onclick="saveEdit(${index})">Simpan</button>
                </div>
            </div>
        `;
    }

    // --- LOGIKA UTAMA (RENDER) ---
    function displayCharacters(data) {
        const container = document.getElementById('card-container');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">Belum ada data karakter.</p>';
            return;
        }
        data.forEach((character) => {
            const originalIndex = charactersData.indexOf(character); 
            container.innerHTML += createCardHTML(character, originalIndex);
        });
    }

    // --- EVENT HANDLERS ---
    
    function handleCardClick(cardElement, event) {
        if (event.target.closest('button')) return; // Don't activate if a button was clicked
        document.querySelectorAll('.char-card').forEach(c => {
            if (c !== cardElement) c.classList.remove('active-card');
        });
        cardElement.classList.toggle('active-card');
    }

    function toggleSkillProgress(index, event) {
        event.stopPropagation();
        charactersData[index].skillProgress.tracked = !charactersData[index].skillProgress.tracked;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(charactersData));
        const sortBy = document.getElementById('sort-by').value;
        displayCharacters(sortCharacters(charactersData, sortBy));
    }

    function activateEditMode(index, event) {
        event.stopPropagation();
        const cardContainer = document.getElementById(`card-${index}`);
        const currentData = charactersData[index];
        cardContainer.outerHTML = createEditFormHTML(currentData, index);
        // Populate select options dynamically
        const elementSelect = document.getElementById(`edit-element-${index}`);
        const elements = ["Fire", "Water", "Wind", "Light", "Dark"];
        elements.forEach(el => {
            const option = document.createElement('option');
            option.value = el;
            option.text = el;
            if (el === currentData.element) option.selected = true;
            elementSelect.appendChild(option);
        });
    }

    function cancelEdit(index) {
        const sortBy = document.getElementById('sort-by').value;
        displayCharacters(sortCharacters(charactersData, sortBy));
    }

    function saveEdit(index) {
        const updatedChar = { ...charactersData[index] };
        
        updatedChar.star = parseInt(document.getElementById(`edit-star-${index}`).value) || 0;
        updatedChar.level = parseInt(document.getElementById(`edit-level-${index}`).value) || 0;
        // ... save other fields ...
        updatedChar.intimacy = parseInt(document.getElementById(`edit-intimacy-${index}`).value) || 0;
        updatedChar.element = document.getElementById(`edit-element-${index}`).value;
        updatedChar.role = document.getElementById(`edit-role-${index}`).value;
        updatedChar.power = document.getElementById(`edit-power-${index}`).value;
        updatedChar.skillOneLevel = parseInt(document.getElementById(`edit-s1-${index}`).value) || 0;
        updatedChar.skillTwoLevel = parseInt(document.getElementById(`edit-s2-${index}`).value) || 0;
        updatedChar.skillThreeLevel = parseInt(document.getElementById(`edit-s3-${index}`).value) || 0;
        updatedChar.skillFourLevel = parseInt(document.getElementById(`edit-s4-${index}`).value) || 0;
        updatedChar.shards = document.getElementById(`edit-shards-${index}`).value;
        updatedChar.shardMax = document.getElementById(`edit-shardMax-${index}`).value;
        updatedChar.cardLevel = parseInt(document.getElementById(`edit-cardLevel-${index}`).value) || 0;
        updatedChar.cardStar = parseInt(document.getElementById(`edit-cardStar-${index}`).value) || 0;


        // Save new skill progress data
        updatedChar.skillProgress.skill = document.getElementById(`edit-trackedSkill-${index}`).value;
        updatedChar.skillProgress.current = parseInt(document.getElementById(`edit-skillCurrent-${index}`).value) || 0;
        updatedChar.skillProgress.max = parseInt(document.getElementById(`edit-skillMax-${index}`).value) || 1; // Avoid division by zero

        charactersData[index] = updatedChar;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(charactersData));

        const sortBy = document.getElementById('sort-by').value;
        displayCharacters(sortCharacters(charactersData, sortBy));
    }

    // --- FUNGSI SORTING & LOAD DATA ---
    function sortCharacters(data, criteria) {
        if (criteria === 'skillProgress') {
            return [...data].sort((a, b) => {
                const aTracked = a.skillProgress?.tracked || false;
                const bTracked = b.skillProgress?.tracked || false;
                if (aTracked && !bTracked) return -1;
                if (!aTracked && bTracked) return 1;
                if (aTracked && bTracked) {
                    const progressA = (a.skillProgress.current / a.skillProgress.max) || 0;
                    const progressB = (b.skillProgress.current / b.skillProgress.max) || 0;
                    if (progressB !== progressA) return progressB - progressA;
                }
                // Fallback to power sort
                const cleanPower = (p) => (String(p).toUpperCase().includes('K') ? parseFloat(p) * 1000 : parseFloat(p)) || 0;
                return cleanPower(b.power) - cleanPower(a.power);
            });
        }
        // ... other sorting criteria ...
        if (criteria === 'default') {
            const elementOrder = { "Fire": 1, "Wind": 2, "Water": 3, "Light": 4, "Dark": 5 };
            return [...data].sort((a, b) => elementOrder[a.element] - elementOrder[b.element]);
        }
        if (criteria === 'power') {
            return [...data].sort((a, b) => {
                const cleanPower = (p) => {
                    let str = String(p).toUpperCase().replace(/,/g, '').replace(/\s/g, '');
                    if (str.includes('K')) return parseFloat(str.replace('K', '')) * 1000;
                    if (str.includes('M')) return parseFloat(str.replace('M', '')) * 1000000;
                    return parseFloat(str) || 0;
                };
                return cleanPower(b.power) - cleanPower(a.power);
            });
        }
        if (criteria === 'shards') {
            return [...data].sort((a, b) => {
                const restA = (parseFloat(a.shardMax) || 0) - (parseFloat(a.shards) || 0);
                const restB = (parseFloat(b.shardMax) || 0) - (parseFloat(b.shards) || 0);
                return restA - restB; 
            });
        }
        if (['level', 'star', 'cardLevel', 'cardStar'].includes(criteria)) {
            return [...data].sort((a, b) => (parseInt(b[criteria]) || 0) - (parseInt(a[criteria]) || 0));
        }
        return data;
    }

    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            let parsedData = JSON.parse(storedData);
            // Data Migration for skillProgress
            parsedData.forEach(char => {
                if (!char.skillProgress) {
                    char.skillProgress = { tracked: false, skill: 'skillTwo', current: 0, max: 1000 };
                }
            });
            charactersData = parsedData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(charactersData)); // Save back migrated data
            displayCharacters(sortCharacters(charactersData, 'power'));
        } else {
            // ... fetch logic ...
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.char-card')) {
                document.querySelectorAll('.char-card').forEach(c => c.classList.remove('active-card'));
            }
        });

        document.getElementById('sort-button').addEventListener('click', () => {
            const sortBy = document.getElementById('sort-by').value;
            displayCharacters(sortCharacters(charactersData, sortBy));
        });
    });
    </script>
</body>
</html>
